<!-- create.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Order - Medical Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
<!-- Navigation -->
<nav class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-xl">
    <div class="container mx-auto px-4 py-3">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <a th:href="@{/}" class="text-xl font-bold">MediCare Store</a>
            </div>
            <div class="space-x-4">
                <a th:href="@{/medicines}" class="hover:text-blue-200 transition duration-200"><i class="fas fa-pills mr-1"></i>Medicines</a>
                <a th:href="@{/categories}" class="hover:text-blue-200 transition duration-200"><i class="fas fa-tags mr-1"></i>Categories</a>
                <a th:href="@{/suppliers}" class="hover:text-blue-200 transition duration-200"><i class="fas fa-truck mr-1"></i>Suppliers</a>
                <a th:href="@{/profile}" class="hover:text-blue-200 transition duration-200"><i class="fas fa-user mr-1"></i>Profile</a>
                <a th:href="@{/logout}" class="hover:text-blue-200 transition duration-200"><i class="fas fa-sign-out-alt mr-1"></i>Logout</a>
            </div>
        </div>
    </div>
</nav>

<!-- Hidden user ID -->
<input type="hidden" id="userId" th:value="${user.userId}" />

<!-- Main Content -->
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white flex items-center">
                    <i class="fas fa-plus-circle mr-3"></i>Create New Order
                </h1>
                <div class="bg-white/20 p-2 rounded-full">
                    <i class="fas fa-shopping-cart text-white"></i>
                </div>
            </div>
        </div>

        <div class="p-6">
            <!-- Medicine Selection -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center text-gray-800">
                    <i class="fas fa-pills mr-2 text-blue-500"></i> Add Medicines to Order
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4 bg-blue-50 rounded-xl">
                    <div>
                        <label for="medicineSelect" class="block text-gray-700 text-sm font-medium mb-2">Select Medicine</label>
                        <div class="relative">
                            <select id="medicineSelect"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 appearance-none bg-white">
                                <option value="">Loading medicines...</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="quantity" class="block text-gray-700 text-sm font-medium mb-2">Quantity</label>
                        <div class="relative">
                            <input type="number" id="quantity" value="1" min="1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        </div>
                    </div>
                </div>
                <button onclick="addMedicineToOrder()"
                        class="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md hover:shadow-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> Add to Order
                </button>
            </div>

            <!-- Order Items -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center text-gray-800">
                    <i class="fas fa-shopping-bag mr-2 text-green-500"></i> Order Items
                </h2>
                <div class="overflow-x-auto rounded-xl shadow-inner border border-gray-100">
                    <table class="min-w-full bg-white">
                        <thead>
                        <tr class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700">
                            <th class="py-4 px-6 text-left font-semibold">Medicine</th>
                            <th class="py-4 px-6 text-left font-semibold">Price</th>
                            <th class="py-4 px-6 text-left font-semibold">Quantity</th>
                            <th class="py-4 px-6 text-left font-semibold">Subtotal</th>
                            <th class="py-4 px-6 text-left font-semibold">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="orderItemsTable">
                        <tr>
                            <td colspan="5" class="py-8 px-4 text-center">
                                <div class="text-gray-400 mb-2">
                                    <i class="fas fa-shopping-cart fa-2x"></i>
                                </div>
                                <p class="text-gray-500">No items added to order</p>
                                <p class="text-sm text-gray-400 mt-1">Add medicines from the selection above</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-right p-4 bg-gray-50 rounded-xl">
                    <p class="text-lg font-semibold text-gray-800">Total: <span class="text-green-600 text-xl">$<span id="orderTotal">0.00</span></span></p>
                </div>
            </div>

            <!-- Order Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <button onclick="clearOrder()"
                        class="bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-6 rounded-xl hover:from-gray-600 hover:to-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 shadow-md hover:shadow-lg flex items-center">
                    <i class="fas fa-trash mr-2"></i> Clear Order
                </button>
                <button onclick="placeOrder()"
                        class="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md hover:shadow-lg flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i> Place Order
                </button>
                <a th:href="@{/profile}"
                   class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md hover:shadow-lg flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Profile
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let medicines = [];
    let orderItems = [];

    // Load medicines when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadMedicines();
    });

    async function loadMedicines() {
        try {
            console.log('Loading medicines...');
            const response = await fetch('/api/medicines');

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Medicines loaded:', data);

            medicines = data;
            populateMedicineSelect();

        } catch (error) {
            console.error('Error loading medicines:', error);
            document.getElementById('medicineSelect').innerHTML = '<option value="">Error loading medicines</option>';
        }
    }

    function populateMedicineSelect() {
        const select = document.getElementById('medicineSelect');

        if (medicines.length === 0) {
            select.innerHTML = '<option value="">No medicines available</option>';
            return;
        }

        select.innerHTML = '<option value="">Select a medicine</option>';

        medicines.forEach(medicine => {
            const option = document.createElement('option');
            option.value = medicine.medicineId;
            option.textContent = `${medicine.name} - $${medicine.price} (Stock: ${medicine.quantity})`;
            option.setAttribute('data-price', medicine.price);
            option.setAttribute('data-name', medicine.name);
            option.setAttribute('data-stock', medicine.quantity);
            select.appendChild(option);
        });

        console.log('Medicine dropdown populated with', medicines.length, 'items');
    }

    function addMedicineToOrder() {
        const medicineSelect = document.getElementById('medicineSelect');
        const quantityInput = document.getElementById('quantity');

        const medicineId = parseInt(medicineSelect.value);
        const quantity = parseInt(quantityInput.value);

        if (!medicineId) {
            alert('Please select a medicine');
            return;
        }

        if (isNaN(quantity) || quantity < 1) {
            alert('Please enter a valid quantity (minimum 1)');
            return;
        }

        const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
        const medicineName = selectedOption.getAttribute('data-name');
        const price = parseFloat(selectedOption.getAttribute('data-price'));
        const stock = parseInt(selectedOption.getAttribute('data-stock'));
        const subtotal = price * quantity;

        // Check stock availability
        if (quantity > stock) {
            alert(`Only ${stock} units available in stock!`);
            return;
        }

        // Check if medicine already in order
        const existingItemIndex = orderItems.findIndex(item => item.medicineId === medicineId);

        if (existingItemIndex > -1) {
            // Update existing item
            const newQuantity = orderItems[existingItemIndex].quantity + quantity;
            if (newQuantity > stock) {
                alert(`Cannot add more than ${stock} units total!`);
                return;
            }
            orderItems[existingItemIndex].quantity = newQuantity;
            orderItems[existingItemIndex].subtotal = orderItems[existingItemIndex].quantity * price;
        } else {
            // Add new item
            orderItems.push({
                medicineId: medicineId,
                medicineName: medicineName,
                price: price,
                quantity: quantity,
                subtotal: subtotal
            });
        }

        updateOrderDisplay();

        // Reset form
        quantityInput.value = 1;
        medicineSelect.focus();
    }

    function updateOrderDisplay() {
        const tbody = document.getElementById('orderItemsTable');
        const totalElement = document.getElementById('orderTotal');

        tbody.innerHTML = '';
        let total = 0;

        orderItems.forEach((item, index) => {
            total += item.subtotal;

            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-blue-50 transition duration-200';
            row.innerHTML = `
                    <td class="py-4 px-6 font-medium">${item.medicineName}</td>
                    <td class="py-4 px-6 font-semibold text-green-600">$${item.price.toFixed(2)}</td>
                    <td class="py-4 px-6">
                        <input type="number" value="${item.quantity}" min="1"
                               onchange="updateQuantity(${index}, this.value)"
                               class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 transition duration-200">
                    </td>
                    <td class="py-4 px-6 font-semibold text-green-600">$${item.subtotal.toFixed(2)}</td>
                    <td class="py-4 px-6">
                        <button onclick="removeOrderItem(${index})"
                                class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition duration-200 text-sm inline-flex items-center">
                            <i class="fas fa-trash mr-1"></i> Remove
                        </button>
                    </td>
                `;
            tbody.appendChild(row);
        });

        totalElement.textContent = total.toFixed(2);

        if (orderItems.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="py-8 px-4 text-center">
                        <div class="text-gray-400 mb-2">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                        <p class="text-gray-500">No items in order</p>
                        <p class="text-sm text-gray-400 mt-1">Add medicines from the selection above</p>
                    </td>
                </tr>
            `;
        }
    }

    function updateQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        if (quantity > 0) {
            // Check stock for this medicine
            const medicineId = orderItems[index].medicineId;
            const medicine = medicines.find(m => m.medicineId === medicineId);

            if (medicine && quantity > medicine.quantity) {
                alert(`Only ${medicine.quantity} units available in stock!`);
                return;
            }

            orderItems[index].quantity = quantity;
            orderItems[index].subtotal = orderItems[index].price * quantity;
            updateOrderDisplay();
        }
    }

    function removeOrderItem(index) {
        orderItems.splice(index, 1);
        updateOrderDisplay();
    }

    function clearOrder() {
        if (orderItems.length === 0) {
            return;
        }

        if (confirm('Are you sure you want to clear the order? All items will be removed.')) {
            orderItems = [];
            updateOrderDisplay();
        }
    }

    async function placeOrder() {
        if (orderItems.length === 0) {
            alert('Please add at least one medicine to the order');
            return;
        }

        const userId = document.getElementById('userId').value;
        const totalAmount = orderItems.reduce((sum, item) => sum + item.subtotal, 0);

        const orderData = {
            userId: parseInt(userId),
            totalAmount: totalAmount,
            status: "PENDING",
            orderDate: new Date().toISOString(),
            orderItems: orderItems.map(item => ({
                medicineId: item.medicineId,
                quantity: item.quantity,
                price: item.price
            }))
        };

        console.log('Placing order:', orderData);

        try {
            // First create the order
            const createResponse = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            const createResult = await createResponse.json();
            console.log('Create order response:', createResult);

            if (createResponse.ok) {
                // Extract order ID from response
                let orderId;
                if (createResult.orderId) {
                    orderId = createResult.orderId;
                } else if (createResult.message) {
                    // Try to parse order ID from message
                    const match = createResult.message.match(/orderId["']?\s*:\s*(\d+)/);
                    orderId = match ? match[1] : null;
                }

                if (orderId) {
                    // Now checkout the order
                    const checkoutData = {
                        orderId: parseInt(orderId),
                        ...orderData
                    };

                    const checkoutResponse = await fetch('/api/orders/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(checkoutData)
                    });

                    const checkoutResult = await checkoutResponse.json();
                    console.log('Checkout response:', checkoutResult);

                    if (checkoutResponse.ok) {
                        alert(`Order placed successfully! Order ID: ${orderId}`);
                        window.location.href = '/profile';
                    } else {
                        alert('Order created but checkout failed: ' + (checkoutResult.error || 'Unknown error'));
                    }
                } else {
                    alert('Order created successfully! (Order ID not returned)');
                    window.location.href = '/profile';
                }
            } else {
                alert('Error creating order: ' + (createResult.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error placing order:', error);
            alert('Error placing order: ' + error.message);
        }
    }

    // Add keyboard shortcut for adding items
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && document.activeElement.id !== 'quantity') {
            addMedicineToOrder();
        }
    });
</script>
</body>
</html>